<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>OpenJsCad STL Viewer + Volume</title>
  <script src="https://openjscad.org/dist/openjscad.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #renderArea { width: 600px; height: 400px; border: 1px solid #ccc; }
    #result { margin-top: 15px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Загрузка STL и подсчёт объёма через OpenJsCad</h1>

  <input type="file" id="fileInput" accept=".stl" />
  <div id="renderArea"></div>
  <div id="result"></div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const renderArea = document.getElementById('renderArea');
    const result = document.getElementById('result');
    let viewer;

    fileInput.addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (!file || !file.name.toLowerCase().endsWith('.stl')) {
        alert('Пожалуйста, выберите STL файл');
        return;
      }

      const arrayBuffer = await file.arrayBuffer();

      // Парсим STL через OpenJsCad
      const openjscad = window.OpenJsCad;

      try {
        const geometry = await openjscad.loadSTL(arrayBuffer);

        // Создаём объект CSG из геометрии
        const csg = openjscad.CSG.fromPolygons(geometry);

        // Инициализируем viewer если нужно
        if (!viewer) {
          viewer = new openjscad.Viewer(renderArea);
          viewer.init();
        }
        viewer.setCsg(csg);

        // Подсчёт объёма
        const vol = csg.volume();

        result.textContent = `Объём модели: ${vol.toFixed(2)} куб.мм`;

      } catch(e) {
        alert('Ошибка при загрузке STL: ' + e.message);
      }
    });
  </script>
</body>
</html>
